<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CORTHON // NEURAL OS</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">
    <link rel="icon" type="image/svg+xml" href="https://api.iconify.design/lucide:cpu.svg?color=%2310b981">
    <link rel="apple-touch-icon" href="https://api.iconify.design/lucide:cpu.svg?color=%2310b981">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        corthon: {
                            bg: '#09090b', 
                            card: '#121214',
                            border: 'rgba(255, 255, 255, 0.08)',
                            emerald: '#10b981',
                            cyan: '#0ea5e9', 
                            orange: '#f97316',
                            danger: '#ef4444',
                            text: '#fafafa',
                            muted: '#a1a1aa',
                            warning: '#eab308' 
                        }
                    },
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'boot-text': 'bootText 2s steps(40, end)',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        bootText: {
                            '0%': { width: '0%' },
                            '100%': { width: '100%' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #09090b;
            color: #fafafa;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #10b981; }

        .glass-panel {
            background: rgba(20, 20, 22, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        .radar-poly { transition: all 1s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Highlight for Tutorial */
        .tutorial-highlight {
            position: relative;
            z-index: 60 !important;
            box-shadow: 0 0 30px 5px rgba(16, 185, 129, 0.25) !important;
            border: 1px solid rgba(16, 185, 129, 0.5);
            pointer-events: auto !important;
            border-radius: 12px;
        }
        
        .tutorial-overlay-container {
            position: fixed;
            inset: 0;
            z-index: 55;
            pointer-events: all; /* Blocks clicks elsewhere */
        }

        /* Input Autofill Fix */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #121214 inset !important;
            -webkit-text-fill-color: white !important;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10b981;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(req => console.log('Corthon Service Worker Registered'))
                    .catch(err => console.log('Service Worker Failed', err));
            });
        }
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Brain, Activity, Zap, CheckCircle2, RotateCcw, 
            Lock, Clock, Flame, ChevronRight, AlertTriangle, 
            Calendar, X, Play, Pause, RefreshCw,
            Plus, Edit3, Trash2, Save, MoreHorizontal,
            HelpCircle, BarChart, LayoutDashboard, LineChart,
            Timer, Quote, AlignLeft, Sun, Moon, Sunrise, Sunset,
            BookOpen, Target, Check, Layers, Flag, Award, Terminal,
            Settings, HardDrive, Bell, Cloud, ShieldAlert, Database, Trash,
            TrendingUp, Percent, History, Hourglass, CalendarDays,
            Coffee, Battery, Briefcase, AlertOctagon, ArrowRight, MousePointer2
        } from 'lucide-react';

        // --- DATABASE SYSTEM (INDEXEDDB) ---
        class CorthonDB {
            constructor() {
                this.dbName = 'CorthonOS_DB';
                this.storeName = 'neural_data';
                this.version = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName, { keyPath: 'id' });
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };

                    request.onerror = (event) => {
                        console.error('Neural Database Error:', event.target.error);
                        reject(event.target.error);
                    };
                });
            }

            async save(key, data) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put({ id: key, value: data, timestamp: Date.now() });
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            async load(key) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);
                    
                    request.onsuccess = () => {
                        resolve(request.result ? request.result.value : null);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async clearAll() {
                 if (!this.db) await this.init();
                 return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                 });
            }
        }

        const neuralDB = new CorthonDB();

        // --- PROFESSIONAL AUDIO SYSTEM ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const now = ctx.currentTime;

                // Helper to play a single tone
                const playTone = (freq, type, startTime, duration, vol = 0.1) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, startTime);
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol, startTime + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + duration);
                };

                if (type === 'complete' || type === 'success') {
                    playTone(880.00, 'sine', now, 0.6, 0.1);      
                    playTone(1108.73, 'sine', now + 0.05, 0.6, 0.1); 
                    playTone(1318.51, 'sine', now + 0.10, 0.8, 0.1); 
                } 
                else if (type === 'click') {
                    playTone(1200, 'sine', now, 0.05, 0.02);
                } 
                else if (type === 'boot') {
                    // Start up sound
                    playTone(220, 'square', now, 0.1, 0.05);
                    playTone(440, 'square', now + 0.1, 0.1, 0.05);
                    playTone(880, 'square', now + 0.2, 0.3, 0.05);
                }
                else if (type === 'purge' || type === 'lazy') {
                    // Deep Bass Drop
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(40, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
                else if (type === 'warning') {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(200, now + 0.2);
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(now);
                    osc.stop(now + 0.2);
                }
                else if (type === 'mercy') {
                     // Soft sine
                    playTone(440, 'sine', now, 0.5, 0.05);
                }
            } catch (e) { console.error(e); }
        };

        // --- CONSTANTS & CONFIG ---
        const XP_DIFFICULTY_SCALAR = 3500; 

        const MOTIVATION_QUOTES = [
            "KontrolsÃ¼z gÃ¼Ã§, gÃ¼Ã§ deÄŸildir.",
            "YÃ¶netemediÄŸin ÅŸeyi Ã¶lÃ§emezsin.",
            "BugÃ¼n ektiÄŸin tohumlar, yarÄ±nki gÃ¶lgeni oluÅŸturur.",
            "Zorluklar, baÅŸarÄ±nÄ±n bedelidir.",
            "MÃ¼kemmellik bir eylem deÄŸil, bir alÄ±ÅŸkanlÄ±ktÄ±r.",
            "AcÄ± geÃ§icidir, vazgeÃ§menin piÅŸmanlÄ±ÄŸÄ± sonsuzdur.",
            "Sistem, kaosun ilacÄ±dÄ±r."
        ];

        const DAYS = [
            { id: 1, name: 'Pazartesi', short: 'Pzt' },
            { id: 2, name: 'SalÄ±', short: 'Sal' },
            { id: 3, name: 'Ã‡arÅŸamba', short: 'Ã‡ar' },
            { id: 4, name: 'PerÅŸembe', short: 'Per' },
            { id: 5, name: 'Cuma', short: 'Cum' },
            { id: 6, name: 'Cumartesi', short: 'Cmt' },
            { id: 0, name: 'Pazar', short: 'Paz' },
        ];

        const CATEGORIES = ['Ä°ÅŸ/Okul', 'Spor', 'GeliÅŸim', 'SaÄŸlÄ±k', 'NAMAZ', 'Sosyal', 'DiÄŸer'];
        
        const SNOOZE_REASONS = [
            { id: 'LAZY', label: 'ÃœÅŸengeÃ§lik', penalty: 50, color: 'text-red-500', bg: 'bg-red-500/10', border: 'border-red-500/20', icon: Coffee },
            { id: 'TIRED', label: 'Yorgunluk', penalty: 15, color: 'text-orange-400', bg: 'bg-orange-400/10', border: 'border-orange-400/20', icon: Battery },
            { id: 'BUSY', label: 'YoÄŸunluk', penalty: 10, color: 'text-blue-400', bg: 'bg-blue-400/10', border: 'border-blue-400/20', icon: Briefcase },
            { id: 'EMERGENCY', label: 'Acil Durum', penalty: 0, color: 'text-emerald-400', bg: 'bg-emerald-400/10', border: 'border-emerald-400/20', icon: AlertOctagon },
        ];

        const MACRO_AXES = {
            'ÃœRETÄ°M': ['Ä°ÅŸ/Okul', 'GeliÅŸim', 'DiÄŸer'],
            'MANEVÄ°YAT': ['NAMAZ'],
            'FÄ°ZÄ°KSEL': ['Spor', 'SaÄŸlÄ±k'],
            'SOSYAL': ['Sosyal']
        };

        const IMPACTS = [
            { id: 'LOW', label: 'DÃ¼ÅŸÃ¼k', xp: 50, color: 'text-gray-400' },
            { id: 'MED', label: 'Orta', xp: 75, color: 'text-blue-400' },
            { id: 'HIGH', label: 'YÃ¼ksek', xp: 100, color: 'text-orange-400' },
            { id: 'CRITICAL', label: 'Kritik', xp: 150, color: 'text-red-400' },
        ];

        // Fetch Prayer Times from API (Method 13 = Diyanet Ä°ÅŸleri BaÅŸkanlÄ±ÄŸÄ±, Turkey)
        const fetchPrayerTimes = async () => {
            const date = new Date().toISOString().split('T')[0];
            const cacheKey = `corthon_prayer_${date}`;
            const cached = localStorage.getItem(cacheKey);

            if (cached) {
                return JSON.parse(cached);
            }

            try {
                // Method 13: Diyanet / Turkey
                const response = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=Istanbul&country=Turkey&method=13`);
                const data = await response.json();
                const timings = data.data.timings;

                // Format: HH:MM
                const formatted = [
                    { name: 'Ä°MSAK', time: timings.Fajr },
                    { name: 'GÃœNEÅž', time: timings.Sunrise },
                    { name: 'Ã–ÄžLE', time: timings.Dhuhr },
                    { name: 'Ä°KÄ°NDÄ°', time: timings.Asr },
                    { name: 'AKÅžAM', time: timings.Maghrib },
                    { name: 'YATSI', time: timings.Isha },
                ];
                
                localStorage.setItem(cacheKey, JSON.stringify(formatted));
                return formatted;
            } catch (error) {
                console.error("Prayer fetch error", error);
                // Fallback (Approximate average times if offline and no cache)
                return [
                    { name: 'Ä°MSAK', time: '05:40' },
                    { name: 'GÃœNEÅž', time: '07:10' },
                    { name: 'Ã–ÄžLE', time: '13:15' },
                    { name: 'Ä°KÄ°NDÄ°', time: '16:05' },
                    { name: 'AKÅžAM', time: '18:15' },
                    { name: 'YATSI', time: '19:40' },
                ];
            }
        };

        const generateInitialRoutine = () => {
            const routine = {};
            // Placeholders, will be updated by API
            const prayerTemplates = [
                { title: 'Sabah NamazÄ±', time: '06:00' }, // Maps to Imsak index 0
                { title: 'Ã–ÄŸle NamazÄ±', time: '13:00' }, // Maps to Ogle index 2 (in our fetch list)
                { title: 'Ä°kindi NamazÄ±', time: '16:00' }, // Maps to Ikindi index 3
                { title: 'AkÅŸam NamazÄ±', time: '18:00' }, // Maps to Aksam index 4
                { title: 'YatsÄ± NamazÄ±', time: '19:30' }  // Maps to Yatsi index 5
            ];

            DAYS.forEach(day => {
                const dayTasks = prayerTemplates.map((p, index) => ({
                    id: `prayer_${day.id}_${index}`,
                    title: p.title,
                    category: 'NAMAZ',
                    time: p.time,
                    completed: false,
                    snoozed: 0,
                    snoozePenalty: 0,
                    impact: 'CRITICAL',
                    note: 'Manevi disiplin esastÄ±r.'
                }));

                if (day.id === 1) {
                    dayTasks.push({ 
                        id: 'sample_task_1', 
                        title: 'Derin Ã‡alÄ±ÅŸma BloÄŸu', 
                        category: 'Ä°ÅŸ/Okul', 
                        time: '09:00', 
                        completed: false, 
                        snoozed: 0, 
                        snoozePenalty: 0,
                        impact: 'HIGH', 
                        note: 'En zorlu gÃ¶revi sabah hallet.' 
                    });
                    dayTasks.sort((a, b) => a.time.localeCompare(b.time));
                }
                
                routine[day.id] = dayTasks;
            });
            return routine;
        };

        // --- COMPONENTS ---

        const CorthonLogo = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="text-corthon-emerald animate-pulse-slow">
                <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M15 9L15.87 6.4C15.96 6.13 16.17 5.92 16.44 5.83L19 5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M15 15L15.87 17.6C15.96 17.87 16.17 18.08 16.44 18.17L19 19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M9.5 9.5C9.5 9.5 10 12 14 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
        );

        const TutorialOverlay = ({ step, onNext, onSkip }) => {
            if (step === 0) return null;

            const steps = [
                { id: 1, text: "Corthon Neural OS'a hoÅŸ geldiniz. Bu bir yapÄ±lacaklar listesi deÄŸil, bir yaÅŸam disiplini protokolÃ¼dÃ¼r. Sisteme entegre olmak iÃ§in talimatlarÄ± izleyin.", target: "CENTER" },
                { id: 2, text: "STATÃœ PANELÄ°: BurasÄ± nÃ¶rolojik seviyenizi gÃ¶sterir. XP kazandÄ±kÃ§a seviye atlarsÄ±nÄ±z. Ä°stikrar (Streak) ve Puan (XP) anlÄ±k olarak iÅŸlenir.", target: "STATS" },
                { id: 3, text: "ZAMAN NAVÄ°GASYONU: GÃ¼nler arasÄ±nda geÃ§iÅŸ yapÄ±n. GeÃ§miÅŸ gÃ¼nlerdeki performansÄ±nÄ±zÄ± inceleyebilir, gelecek gÃ¼nleri planlayabilirsiniz.", target: "DAYS" },
                { id: 4, text: "PROTOKOL GÄ°RÄ°ÅžÄ°: (+) Butonu ile sisteme yeni gÃ¶revler (protokoller) ekleyin. Ä°ÅŸ, Spor, Maneviyat gibi kategoriler seÃ§in.", target: "ADD_BTN" },
                { id: 5, text: "GÃœN SONU RAPORU: GÃ¼n bittiÄŸinde bu butona basÄ±n. Sistem veriminizi hesaplar (%80+ verim bonus kazandÄ±rÄ±r) ve gÃ¼nÃ¼ kilitler.", target: "COMPLETE_BTN" },
                { id: 6, text: "SÄ°STEM AYARLARI: Performans analizi ve sistem ayarlarÄ±na buradan ulaÅŸÄ±n. HazÄ±rsanÄ±z baÅŸlayalÄ±m.", target: "MENU" }
            ];

            const current = steps.find(s => s.id === step);
            if (!current) return null;

            return (
                <div className="tutorial-overlay-container flex flex-col items-center justify-center p-6 animate-fade-in" onClick={(e) => { e.stopPropagation(); onNext(); }}>
                    <div className={`
                        max-w-xs w-full bg-[#121214] border border-corthon-emerald shadow-[0_0_30px_rgba(16,185,129,0.2)] rounded-2xl p-6 relative z-[70] transition-all duration-500
                        ${step === 1 ? 'scale-100' : 'scale-95 translate-y-10'}
                        ${step === 4 ? 'absolute bottom-32 right-6' : ''}
                        ${step === 5 ? 'absolute bottom-24 left-1/2 -translate-x-1/2' : ''}
                        ${step === 6 ? 'absolute top-20 left-1/2 -translate-x-1/2' : ''}
                    `}>
                        <div className="absolute -top-3 -left-3 bg-black border border-corthon-emerald text-corthon-emerald text-[10px] font-bold px-2 py-0.5 rounded">TUTORIAL_MODE_v1</div>
                        
                        <div className="flex items-start gap-3 mb-4">
                            <BotAvatar />
                            <div>
                                <h3 className="text-corthon-emerald font-bold text-sm tracking-wider mb-1">EÄžÄ°TÄ°M MODÃœLÃœ {step}/6</h3>
                                <p className="text-xs text-gray-300 leading-relaxed font-mono">{current.text}</p>
                            </div>
                        </div>

                        <div className="flex justify-between items-center mt-2">
                            <button onClick={(e) => { e.stopPropagation(); onSkip(); }} className="text-[10px] text-gray-500 hover:text-white underline">EÄŸitimi Atla</button>
                            <div className="flex items-center gap-2 text-[10px] text-corthon-emerald animate-pulse">
                                <span>DEVAM ETMEK Ä°Ã‡Ä°N DOKUN</span> <ChevronRight size={12}/>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const BotAvatar = () => (
            <div className="w-8 h-8 rounded-full bg-corthon-emerald/20 flex items-center justify-center border border-corthon-emerald/50 shrink-0 animate-float">
                <Brain size={16} className="text-corthon-emerald"/>
            </div>
        );

        const BootScreen = ({ onComplete }) => {
            const [step, setStep] = useState(0);
            
            useEffect(() => {
                const timers = [
                    setTimeout(() => setStep(1), 500),
                    setTimeout(() => setStep(2), 1200),
                    setTimeout(() => setStep(3), 2000),
                    setTimeout(() => { playSound('boot'); onComplete(); }, 2800)
                ];
                return () => timers.forEach(clearTimeout);
            }, []);

            return (
                <div className="fixed inset-0 z-[200] bg-[#09090b] flex flex-col items-center justify-center p-8 font-mono">
                    <div className="w-full max-w-sm">
                        <div className="flex justify-center mb-8 relative">
                             <div className="absolute inset-0 bg-corthon-emerald/20 blur-xl rounded-full animate-pulse"></div>
                             <CorthonLogo />
                        </div>
                        
                        <div className="space-y-2 mb-8 h-32 text-xs text-corthon-emerald/80">
                            {step >= 0 && <div className="animate-slide-up">> BAÅžLATILIYOR: CORTHON_NEURAL_CORE...</div>}
                            {step >= 1 && <div className="animate-slide-up">> VERÄ°TABANI BAÄžLANTISI: [OK]</div>}
                            {step >= 1 && <div className="animate-slide-up">> KORTÄ°ZOL SEVÄ°YELERÄ°: TARANIYOR...</div>}
                            {step >= 2 && <div className="animate-slide-up">> DOPAMÄ°N RESEPTÃ–RLERÄ°: AKTÄ°F</div>}
                            {step >= 2 && <div className="animate-slide-up text-white">> SÄ°STEM HAZIR.</div>}
                        </div>

                        <div className="h-1 w-full bg-gray-900 rounded-full overflow-hidden">
                            <div 
                                className="h-full bg-corthon-emerald transition-all duration-[2000ms] ease-out"
                                style={{ width: step === 3 ? '100%' : step === 0 ? '0%' : '60%' }}
                            ></div>
                        </div>
                    </div>
                </div>
            );
        };

        const Greeting = ({ name }) => {
            const hour = new Date().getHours();
            let greet = "Sistem Ã‡evrimiÃ§i";
            let icon = <Sun size={20} className="text-yellow-500" />;
            
            if (hour < 6) { greet = "Gece Modu"; icon = <Moon size={20} className="text-purple-400" />; }
            else if (hour < 11) { greet = "Sabah ProtokolÃ¼"; icon = <Sunrise size={20} className="text-orange-400" />; }
            else if (hour > 18) { greet = "AkÅŸam Ã–zeti"; icon = <Sunset size={20} className="text-indigo-400" />; }

            const randomQuote = useMemo(() => MOTIVATION_QUOTES[Math.floor(Math.random() * MOTIVATION_QUOTES.length)], []);

            return (
                <div className="mb-6 animate-fade-in">
                    <div className="flex items-center gap-2 mb-2 text-corthon-muted font-medium text-sm">
                        {icon}
                        <span>{greet}</span>
                    </div>
                    <div className="text-sm text-gray-400 italic font-serif opacity-80 border-l-2 border-corthon-emerald pl-3">
                        "{randomQuote}"
                    </div>
                </div>
            );
        };

        const Heatmap = ({ history }) => {
            const days = useMemo(() => {
                const result = [];
                for (let i = 29; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const iso = d.toISOString().split('T')[0];
                    const dayName = ['Paz','Pzt','Sal','Ã‡ar','Per','Cum','Cmt'][d.getDay()];
                    result.push({ date: iso, dayName });
                }
                return result;
            }, []);

            return (
                <div className="w-full overflow-x-auto pb-4 scrollbar-hide">
                   <div className="flex gap-1.5 min-w-max">
                        {days.map((d, i) => {
                            const data = history[d.date];
                            const hasActivity = data && Object.keys(data.categories || {}).length > 0;
                            return (
                                <div key={i} className="flex flex-col items-center gap-1">
                                    <div className="h-20 w-1 flex items-end bg-white/5 rounded-full overflow-hidden relative">
                                        <div 
                                            className={`w-full rounded-full transition-all duration-500 ${hasActivity ? 'bg-corthon-emerald' : 'bg-transparent'}`} 
                                            style={{ height: hasActivity ? '100%' : '0%' }}
                                        ></div>
                                    </div>
                                    <span className="text-[9px] text-gray-600 font-mono -rotate-90 mt-2">{d.dayName}</span>
                                </div>
                            )
                        })}
                   </div>
                   <div className="flex justify-between mt-2 px-1">
                        <span className="text-[10px] text-gray-500">30 GÃ¼n Ã–nce</span>
                        <span className="text-[10px] text-corthon-emerald font-bold">BUGÃœN</span>
                   </div>
                </div>
            );
        };

        const RadarChart = ({ stats }) => {
            const maxVal = Math.max(...Object.values(stats), 1);
            
            const p = (stats.ÃœRETÄ°M || 0) / maxVal;
            const s = (stats.SOSYAL || 0) / maxVal;
            const f = (stats.FÄ°ZÄ°KSEL || 0) / maxVal;
            const m = (stats.MANEVÄ°YAT || 0) / maxVal;

            const getCoord = (val, angle) => {
                const r = val * 80;
                const rad = (angle - 90) * (Math.PI / 180);
                return {
                    x: 100 + r * Math.cos(rad),
                    y: 100 + r * Math.sin(rad)
                };
            };

            const p1 = getCoord(p, 0);   
            const p2 = getCoord(s, 90);  
            const p3 = getCoord(f, 180); 
            const p4 = getCoord(m, 270); 

            const polyPoints = `${p1.x},${p1.y} ${p2.x},${p2.y} ${p3.x},${p3.y} ${p4.x},${p4.y}`;

            return (
                <div className="relative w-full max-w-[220px] aspect-square mx-auto my-6">
                    <svg viewBox="0 0 200 200" className="w-full h-full">
                        <circle cx="100" cy="100" r="20" className="fill-none stroke-gray-800 stroke-[0.5]"/>
                        <circle cx="100" cy="100" r="40" className="fill-none stroke-gray-800 stroke-[0.5]"/>
                        <circle cx="100" cy="100" r="60" className="fill-none stroke-gray-800 stroke-[0.5]"/>
                        <circle cx="100" cy="100" r="80" className="fill-none stroke-gray-700 stroke-[0.5]"/>
                        
                        <line x1="100" y1="20" x2="100" y2="180" className="stroke-gray-800 stroke-[0.5]"/>
                        <line x1="20" y1="100" x2="180" y2="100" className="stroke-gray-800 stroke-[0.5]"/>

                        <polygon points={polyPoints} className="fill-corthon-emerald/20 stroke-corthon-emerald stroke-2 radar-poly" />
                        
                        <circle cx={p1.x} cy={p1.y} r="3" className="fill-corthon-text"/>
                        <circle cx={p2.x} cy={p2.y} r="3" className="fill-corthon-text"/>
                        <circle cx={p3.x} cy={p3.y} r="3" className="fill-corthon-text"/>
                        <circle cx={p4.x} cy={p4.y} r="3" className="fill-corthon-text"/>
                    </svg>

                    <div className="absolute top-0 left-1/2 -translate-x-1/2 -mt-3 text-[9px] font-bold text-gray-400 tracking-wider">ÃœRETÄ°M</div>
                    <div className="absolute bottom-0 left-1/2 -translate-x-1/2 -mb-3 text-[9px] font-bold text-gray-400 tracking-wider">FÄ°ZÄ°KSEL</div>
                    <div className="absolute top-1/2 left-0 -translate-x-1/2 -ml-6 text-[9px] font-bold text-gray-400 tracking-wider">MANEVÄ°</div>
                    <div className="absolute top-1/2 right-0 -translate-x-1/2 -mr-6 text-[9px] font-bold text-gray-400 tracking-wider">SOSYAL</div>
                </div>
            );
        };

        const SnoozeModal = ({ isOpen, onClose, task, onConfirm, onReschedule, onUndo }) => {
            const [mode, setMode] = useState('REASON');

            if (!isOpen || !task) return null;

            return (
                <div className="fixed inset-0 z-[120] flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 modal-overlay" onClick={onClose}></div>
                    <div className="relative w-full max-w-lg bg-[#121214] border-t sm:border border-white/10 rounded-t-2xl sm:rounded-2xl p-6 animate-slide-up safe-area-bottom shadow-2xl">
                        
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h3 className="font-bold text-lg text-white flex items-center gap-2">
                                    <AlertTriangle size={20} className="text-corthon-warning"/>
                                    Ä°rade SorgulamasÄ±
                                </h3>
                                <p className="text-xs text-gray-400 mt-1">"{task.title}" neden yapÄ±lmadÄ±?</p>
                            </div>
                            <button onClick={onClose}><X size={20} className="text-gray-500 hover:text-white"/></button>
                        </div>

                        {task.snoozed > 0 && (
                            <div className="mb-6">
                                <button 
                                    onClick={onUndo}
                                    className="w-full py-3 bg-corthon-emerald/10 border border-corthon-emerald/30 text-corthon-emerald rounded-xl flex items-center justify-center gap-2 text-sm font-bold hover:bg-corthon-emerald/20 transition-all"
                                >
                                    <RotateCcw size={16}/> ERTELEMEYÄ° GERÄ° AL (XP Ä°ADE)
                                </button>
                                <div className="text-[10px] text-center text-gray-500 mt-2">Bu gÃ¶revi {task.snoozed} kez erteledin.</div>
                            </div>
                        )}

                        <div className="flex bg-white/5 p-1 rounded-xl mb-6">
                            <button onClick={() => setMode('REASON')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${mode === 'REASON' ? 'bg-gray-800 text-white shadow' : 'text-gray-500'}`}>ERTELE (BUGÃœN)</button>
                            <button onClick={() => setMode('SCHEDULE')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${mode === 'SCHEDULE' ? 'bg-gray-800 text-white shadow' : 'text-gray-500'}`}>Ã–TELE (TAÅžI)</button>
                        </div>

                        {mode === 'REASON' && (
                            <div className="grid grid-cols-2 gap-3">
                                {SNOOZE_REASONS.map(reason => (
                                    <button 
                                        key={reason.id}
                                        onClick={() => onConfirm(reason)}
                                        className={`p-4 rounded-xl border flex flex-col items-center justify-center gap-2 transition-all hover:scale-[1.02] active:scale-95 ${reason.bg} ${reason.border}`}
                                    >
                                        <reason.icon size={24} className={reason.color} />
                                        <span className={`text-xs font-bold ${reason.color}`}>{reason.label}</span>
                                        <span className="text-[10px] bg-black/40 px-2 py-0.5 rounded text-white/70">
                                            {reason.penalty > 0 ? `-${reason.penalty} XP` : 'Ceza Yok'}
                                        </span>
                                    </button>
                                ))}
                            </div>
                        )}

                        {mode === 'SCHEDULE' && (
                            <div className="space-y-4">
                                <p className="text-xs text-gray-400 text-center">GÃ¶revi baÅŸka bir gÃ¼ne taÅŸÄ±yorsun. Bu bir planlama hatasÄ±dÄ±r.</p>
                                <div className="grid grid-cols-3 gap-2">
                                    {DAYS.filter(d => d.id !== 0 && d.id !== new Date().getDay()).slice(0, 6).map(d => (
                                        <button 
                                            key={d.id}
                                            onClick={() => onReschedule(d.id)}
                                            className="p-3 bg-white/5 border border-white/5 hover:border-white/20 rounded-xl text-sm text-gray-300 hover:text-white transition-all flex flex-col items-center"
                                        >
                                            <span className="font-bold">{d.short}</span>
                                            <span className="text-[10px] text-gray-500 mt-1">-25 XP</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const FocusMode = ({ active, task, onClose }) => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isRunning, setIsRunning] = useState(false);
            const [mode, setMode] = useState('SETUP'); 

            useEffect(() => {
                let interval = null;
                if (isRunning && timeLeft > 0) {
                    interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                } else if (timeLeft === 0 && isRunning) {
                    playSound('complete');
                    setIsRunning(false);
                }
                return () => clearInterval(interval);
            }, [isRunning, timeLeft]);

            const startTimer = (mins) => {
                setTimeLeft(mins * 60);
                setMode('RUNNING');
                setIsRunning(true);
                playSound('click');
            };

            if (!active) return null;

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            return (
                <div className="fixed inset-0 z-[70] bg-[#09090b] flex flex-col items-center justify-center p-6 animate-fade-in">
                    <button onClick={onClose} className="absolute top-6 right-6 p-2 bg-white/5 rounded-full text-gray-400 hover:text-white">
                        <X size={24} />
                    </button>

                    <div className="max-w-md w-full text-center relative z-10">
                        <div className="mb-10">
                            <Brain size={48} className="mx-auto text-corthon-emerald mb-6 animate-pulse-slow" />
                            <h2 className="text-2xl font-bold text-white mb-2">{task?.title || 'Odaklanma Modu'}</h2>
                            <p className="text-gray-500 text-sm">Dikkat daÄŸÄ±tÄ±cÄ± unsurlarÄ± ortadan kaldÄ±r.</p>
                        </div>

                        {mode === 'SETUP' ? (
                            <div className="grid grid-cols-3 gap-4">
                                <button onClick={() => startTimer(15)} className="p-5 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-corthon-emerald transition-all group">
                                    <div className="text-2xl font-bold mb-1 group-hover:text-corthon-emerald transition-colors">15</div>
                                    <div className="text-[10px] uppercase tracking-wider text-gray-500">HÄ±zlÄ±</div>
                                </button>
                                <button onClick={() => startTimer(25)} className="p-5 rounded-2xl bg-corthon-emerald/10 border border-corthon-emerald/50 hover:bg-corthon-emerald/20 transition-all">
                                    <div className="text-2xl font-bold mb-1 text-corthon-emerald">25</div>
                                    <div className="text-[10px] uppercase tracking-wider text-corthon-emerald">Pomodoro</div>
                                </button>
                                <button onClick={() => startTimer(60)} className="p-5 rounded-2xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-corthon-emerald transition-all group">
                                    <div className="text-2xl font-bold mb-1 group-hover:text-corthon-emerald transition-colors">60</div>
                                    <div className="text-[10px] uppercase tracking-wider text-gray-500">Derin Ä°ÅŸ</div>
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-10">
                                <div className="text-8xl font-mono font-bold tracking-tighter tabular-nums text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500">
                                    {formatTime(timeLeft)}
                                </div>
                                <div className="flex gap-4 justify-center">
                                    <button onClick={() => setIsRunning(!isRunning)} className="px-8 py-4 rounded-full bg-white text-black font-bold flex items-center gap-2 hover:bg-gray-200 transition-colors">
                                        {isRunning ? <><Pause size={20}/> Duraklat</> : <><Play size={20}/> BaÅŸlat</>}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ManualModal = ({ isOpen, onClose, onRestartTutorial }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[120] flex items-center justify-center p-4">
                    <div className="absolute inset-0 modal-overlay" onClick={onClose}></div>
                    <div className="relative w-full max-w-2xl bg-[#121214] border border-white/10 rounded-2xl overflow-hidden flex flex-col max-h-[85vh] animate-slide-up shadow-2xl">
                        <div className="p-5 border-b border-white/5 flex justify-between items-center bg-white/5 backdrop-blur-md sticky top-0 z-10">
                             <h2 className="text-lg font-bold text-white flex items-center gap-2"><BookOpen size={20} className="text-corthon-emerald"/> Corthon ProtokolÃ¼ v1.0</h2>
                            <button onClick={onClose} className="p-1 hover:bg-white/10 rounded-full transition-colors"><X className="text-gray-500 hover:text-white" size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-8 font-sans text-sm text-gray-300 custom-scrollbar leading-relaxed">
                            <section>
                                <h3 className="text-corthon-emerald font-bold mb-3 flex items-center gap-2 text-base tracking-wide border-b border-white/5 pb-2"><Brain size={18}/> TEMEL FELSEFE</h3>
                                <p className="opacity-90 mb-3">Corthon, basit bir gÃ¶rev yÃ¶neticisi deÄŸil, nÃ¶rolojik odaklanma protokolÃ¼dÃ¼r. AmacÄ± dopamin sisteminizi "tamamlama hazzÄ±" ile eÄŸitmek ve disiplin sÄ±zÄ±ntÄ±larÄ±nÄ± (erteleme) gÃ¶rÃ¼nÃ¼r kÄ±larak utandÄ±rmaktÄ±r.</p>
                            </section>
                            
                            <section>
                                <h3 className="text-yellow-500 font-bold mb-3 flex items-center gap-2 text-base tracking-wide border-b border-white/5 pb-2"><Zap size={18}/> XP ALGORÄ°TMASI</h3>
                                <ul className="space-y-2">
                                    <li className="flex gap-2"><span className="text-corthon-emerald font-mono">DÃ¼ÅŸÃ¼k Ã–ncelik:</span> 50 XP</li>
                                    <li className="flex gap-2"><span className="text-blue-400 font-mono">Orta Ã–ncelik:</span> 75 XP</li>
                                    <li className="flex gap-2"><span className="text-orange-400 font-mono">YÃ¼ksek Ã–ncelik:</span> 100 XP</li>
                                    <li className="flex gap-2"><span className="text-red-400 font-mono">Kritik:</span> 150 XP</li>
                                    <li className="mt-2 text-xs italic opacity-70 border-l-2 border-yellow-500 pl-2">GÃ¼nÃ¼ %80 Ã¼zerinde verimle kapatmak +150 Bonus XP kazandÄ±rÄ±r.</li>
                                </ul>
                            </section>

                            <section>
                                <h3 className="text-red-500 font-bold mb-3 flex items-center gap-2 text-base tracking-wide border-b border-white/5 pb-2"><AlertTriangle size={18}/> Ä°RADE YÃ–NETÄ°MÄ°</h3>
                                <p className="mb-2">Bir gÃ¶revi yapmadÄ±ÄŸÄ±nÄ±zda <strong>Ä°rade SorgulamasÄ±</strong> devreye girer. Erteleme sebebinize gÃ¶re XP cezasÄ± alÄ±rsÄ±nÄ±z:</p>
                                <ul className="grid grid-cols-2 gap-2 text-xs">
                                    <li className="bg-white/5 p-2 rounded border border-white/5">â˜• ÃœÅŸengeÃ§lik: <span className="text-red-400">-50 XP</span></li>
                                    <li className="bg-white/5 p-2 rounded border border-white/5">ðŸ”‹ Yorgunluk: <span className="text-orange-400">-15 XP</span></li>
                                    <li className="bg-white/5 p-2 rounded border border-white/5">ðŸ’¼ YoÄŸunluk: <span className="text-blue-400">-10 XP</span></li>
                                    <li className="bg-white/5 p-2 rounded border border-white/5">ðŸ›‘ Acil Durum: <span className="text-emerald-400">0 XP</span></li>
                                </ul>
                            </section>

                             <section>
                                <h3 className="text-corthon-cyan font-bold mb-3 flex items-center gap-2 text-base tracking-wide border-b border-white/5 pb-2"><RefreshCw size={18}/> ZAMAN DÃ–NGÃœSÃœ</h3>
                                <p className="mb-2"><strong className="text-white">GÃ¼nÃ¼ Tamamla:</strong> O gÃ¼nkÃ¼ performansÄ± kilitler ve raporlar. GÃ¶revler silinmez, bÃ¶ylece geÃ§miÅŸe dÃ¶nÃ¼p bakabilirsiniz.</p>
                                <p><strong className="text-white">HaftayÄ± Bitir:</strong> Pazar gÃ¼nleri veya manuel olarak tetiklenir. TÃ¼m haftanÄ±n gÃ¶revlerini ve tiklerini temizler. Yeni bir sayfa aÃ§ar.</p>
                            </section>

                            <div className="pt-6 border-t border-white/10">
                                <button 
                                    onClick={() => { onClose(); onRestartTutorial(); }}
                                    className="w-full py-4 bg-corthon-emerald/10 border border-corthon-emerald/50 text-corthon-emerald font-bold rounded-xl hover:bg-corthon-emerald/20 transition-all flex items-center justify-center gap-2 text-xs tracking-wider"
                                >
                                    <MousePointer2 size={16}/> EÄžÄ°TÄ°M PROTOKOLÃœNÃœ YENÄ°DEN BAÅžLAT
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SummaryModal = ({ isOpen, onClose, xp, tasks, onConfirm }) => {
            if (!isOpen) return null;
            return (
                 <div className="fixed inset-0 z-[120] flex items-center justify-center p-4">
                    <div className="absolute inset-0 modal-overlay" onClick={onClose}></div>
                    <div className="relative w-full max-w-sm bg-[#121214] border border-white/10 rounded-2xl p-6 animate-slide-up shadow-2xl text-center">
                        <RefreshCw size={48} className="mx-auto text-corthon-cyan mb-4 animate-spin-slow" />
                        <h3 className="text-xl font-bold text-white mb-2">HaftalÄ±k DÃ¶ngÃ¼ TamamlandÄ±</h3>
                        <div className="py-4 space-y-2">
                            <div className="flex justify-between text-sm border-b border-white/5 pb-2">
                                <span className="text-gray-400">Toplam XP KazancÄ±</span>
                                <span className="text-corthon-emerald font-bold">+{xp} XP</span>
                            </div>
                            <div className="flex justify-between text-sm border-b border-white/5 pb-2">
                                <span className="text-gray-400">Streak Bonusu</span>
                                <span className="text-corthon-orange font-bold">+1 Seri</span>
                            </div>
                        </div>
                        <p className="text-xs text-gray-500 mb-6 mt-4">Sistem yeniden baÅŸlatÄ±lacak ve tÃ¼m gÃ¶revler sÄ±fÄ±rlanacak. OnaylÄ±yor musun?</p>
                        <button onClick={onConfirm} className="w-full py-3 bg-corthon-cyan text-black font-bold rounded-xl hover:bg-cyan-400 transition-colors">SÄ°STEMÄ° YENÄ°LE</button>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ onPurge, storageStatus, settings, onToggleSetting, onForceWeekReset }) => {
            return (
                <div className="animate-slide-up space-y-6 pb-20">
                    <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-2xl flex items-start gap-4">
                        <div className="p-3 bg-red-500/20 rounded-xl text-red-500">
                            <ShieldAlert size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-red-500 mb-1">Sistem Protokolleri</h3>
                            <p className="text-xs text-gray-400 leading-relaxed">
                                Bu alan kritik sistem ayarlarÄ±na eriÅŸim saÄŸlar. Dikkatli kullanÄ±n.
                            </p>
                        </div>
                    </div>

                    <div className="glass-panel p-6 rounded-2xl space-y-6">
                        <div className="flex items-center gap-2 text-corthon-cyan font-bold text-sm tracking-wider uppercase mb-2">
                            <Settings size={16} /> Manuel MÃ¼dahaleler
                        </div>

                        <button 
                            onClick={onForceWeekReset}
                            className="w-full py-3 bg-white/5 border border-white/10 rounded-xl flex items-center justify-between px-4 hover:bg-white/10 transition-colors group"
                        >
                            <span className="text-sm font-medium text-gray-300">HaftalÄ±k DÃ¶ngÃ¼yÃ¼ Manuel SÄ±fÄ±rla</span>
                            <RefreshCw size={16} className="text-corthon-cyan group-hover:rotate-180 transition-transform"/>
                        </button>

                         <div className="flex items-center justify-between mt-4">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-white/5 rounded-lg text-gray-400"><Bell size={18}/></div>
                                <div><div className="text-sm font-medium text-white">Bildirim Ä°zinleri</div></div>
                            </div>
                            <button onClick={() => onToggleSetting('notifications')} className={`w-12 h-6 rounded-full relative transition-colors ${settings.notifications ? 'bg-corthon-emerald' : 'bg-gray-700'}`}>
                                <div className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-all shadow-md ${settings.notifications ? 'left-7' : 'left-1'}`}></div>
                            </button>
                        </div>
                    </div>

                    <div className="glass-panel border-red-500/30 p-6 rounded-2xl space-y-4">
                        <div className="flex items-center gap-2 text-red-500 font-bold text-sm tracking-wider uppercase mb-2">
                            <AlertTriangle size={16} /> Tehlike BÃ¶lgesi
                        </div>
                        <button onClick={onPurge} className="w-full py-4 border border-red-500/50 text-red-500 hover:bg-red-500 hover:text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all group">
                            <Trash size={18} className="group-hover:animate-bounce"/> SÄ°STEMÄ° TAMAMEN SIFIRLA (PURGE)
                        </button>
                    </div>
                </div>
            );
        };

        const TaskEditor = ({ isOpen, onClose, onSave, onDelete, initialData }) => {
            const [title, setTitle] = useState('');
            const [note, setNote] = useState('');
            const [category, setCategory] = useState('DiÄŸer');
            const [time, setTime] = useState('09:00');
            const [impact, setImpact] = useState('MED');

            useEffect(() => {
                if (isOpen) {
                    setTitle(initialData?.title || '');
                    setNote(initialData?.note || '');
                    setCategory(initialData?.category || 'DiÄŸer');
                    setTime(initialData?.time || '09:00');
                    setImpact(initialData?.impact || 'MED');
                }
            }, [isOpen, initialData]);

            const handleSubmit = (e) => {
                e.preventDefault(); 
                if (title) {
                    onSave({ title, note, category, time, impact });
                }
            };
            
            const handleDelete = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (initialData && initialData.id) onDelete(initialData.id);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[110] flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 modal-overlay" onClick={onClose}></div>
                    <form onSubmit={handleSubmit} className="relative w-full max-w-lg bg-[#121214] border-t sm:border border-white/10 rounded-t-2xl sm:rounded-2xl p-6 transform transition-transform duration-300 animate-slide-up safe-area-bottom shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg text-white">{initialData ? 'GÃ¶revi DÃ¼zenle' : 'Yeni GÃ¶rev'}</h3>
                            <button type="button" onClick={onClose}><X size={20} className="text-gray-500 hover:text-white"/></button>
                        </div>
                        <div className="space-y-5">
                            <div><input value={title} onChange={(e) => setTitle(e.target.value)} className="w-full bg-transparent text-2xl font-bold placeholder-gray-700 outline-none text-white" placeholder="Ne yapacaksÄ±n?" autoFocus /></div>
                            <div className="flex gap-3">
                                <div className="flex-1 bg-white/5 rounded-xl p-3 border border-white/5 focus-within:border-white/20 transition-colors flex items-center gap-2">
                                    <Clock size={16} className="text-gray-500 ml-1"/><input type="time" value={time} onChange={(e) => setTime(e.target.value)} className="bg-transparent w-full outline-none text-sm font-mono text-white"/>
                                </div>
                                <div className="flex-1 bg-white/5 rounded-xl p-3 border border-white/5">
                                    <select value={impact} onChange={(e) => setImpact(e.target.value)} className="w-full bg-transparent outline-none text-sm appearance-none px-2 text-white">
                                        {IMPACTS.map(i => <option key={i.id} value={i.id} className="bg-gray-900">{i.label} Ã–ncelik</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-2 py-1">
                                {CATEGORIES.filter(c => c !== 'NAMAZ').map(c => (
                                    <button type="button" key={c} onClick={() => setCategory(c)} className={`text-xs px-3 py-1.5 rounded-full border transition-all ${category === c ? 'bg-white text-black border-white font-medium' : 'bg-transparent text-gray-500 border-white/10 hover:border-white/30'}`}>{c}</button>
                                ))}
                            </div>
                            <div className="bg-white/5 rounded-xl p-4 border border-white/5">
                                <textarea value={note} onChange={(e) => setNote(e.target.value)} placeholder="Notlar, linkler veya alt adÄ±mlar..." className="w-full bg-transparent outline-none text-sm min-h-[80px] resize-none placeholder-gray-600 text-gray-300 font-sans leading-relaxed"/>
                            </div>
                            <div className="pt-4 flex flex-col gap-3">
                                <button type="submit" disabled={!title} className="w-full p-4 bg-corthon-emerald text-black font-bold rounded-xl hover:bg-emerald-400 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2 transition-colors shadow-lg shadow-emerald-900/20"><Save size={18} /> {initialData ? 'DeÄŸiÅŸiklikleri Kaydet' : 'GÃ¶revi OluÅŸtur'}</button>
                                {initialData && (<button type="button" onClick={handleDelete} className="w-full p-4 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500/20 border border-red-500/20 flex justify-center items-center gap-2 font-bold transition-all"><Trash2 size={18} /> GÃ¶revi Sil</button>)}
                            </div>
                        </div>
                    </form>
                </div>
            );
        };

        const App = () => {
            const [mounted, setMounted] = useState(false);
            const [xp, setXp] = useState(0);
            const [streak, setStreak] = useState(0);
            const [selectedDayId, setSelectedDayId] = useState(new Date().getDay());
            const [tasks, setTasks] = useState(generateInitialRoutine());
            const [history, setHistory] = useState({});
            const [view, setView] = useState('FLOW');
            const [modalOpen, setModalOpen] = useState(false);
            const [manualOpen, setManualOpen] = useState(false);
            const [summaryOpen, setSummaryOpen] = useState(false);
            const [snoozeModal, setSnoozeModal] = useState({ open: false, task: null });
            const [editingTask, setEditingTask] = useState(null);
            const [focusMode, setFocusMode] = useState({ active: false, task: null });
            const [prayerTimes, setPrayerTimes] = useState([]);
            const [toast, setToast] = useState({ msg: null, type: 'neutral' });
            const [storageStatus, setStorageStatus] = useState({ persisted: false, quota: 0, usage: 0 });
            const [settings, setAppSettings] = useState({ notifications: false, sync: false });
            const [isResetting, setIsResetting] = useState(false);
            
            // Tutorial State
            const [tutorialStep, setTutorialStep] = useState(0);

            useEffect(() => {
                const initSystem = async () => {
                    // Load DB...
                    try {
                        const savedData = await neuralDB.load('corthon_core');
                        if (savedData) {
                            setXp(savedData.xp || 0);
                            setStreak(savedData.streak || 0);
                            setTasks({ ...generateInitialRoutine(), ...savedData.tasks });
                            setHistory(savedData.history || {});
                            setAppSettings(savedData.settings || { notifications: false, sync: false });
                        } else {
                             const localData = localStorage.getItem('corthon_pro_v1');
                             if(localData) {
                                const parsed = JSON.parse(localData);
                                setXp(parsed.xp || 0);
                                setStreak(parsed.streak || 0);
                                setTasks(parsed.tasks || generateInitialRoutine());
                                setHistory(parsed.history || {});
                             }
                        }
                    } catch (e) {
                        console.error("System Boot Failure:", e);
                    }

                    // Fetch Real Prayer Times for Istanbul
                    const times = await fetchPrayerTimes();
                    setPrayerTimes(times);
                    
                    // Update task times in state if they exist
                    setTasks(prevTasks => {
                        const newTasks = { ...prevTasks };
                        Object.keys(newTasks).forEach(dayId => {
                            newTasks[dayId] = newTasks[dayId].map(t => {
                                if (t.category === 'NAMAZ' && t.id.includes('prayer_')) {
                                    let timeStr = t.time;
                                    // Map prayer indices to fetched data (Aladhan array order: Imsak, Gunes, Ogle, Ikindi, Aksam, Yatsi)
                                    // Original template order: Sabah(0), Ogle(1), Ikindi(2), Aksam(3), Yatsi(4)
                                    // Sabah Namazi typically associated with Imsak time for start
                                    
                                    if (t.id.includes('_0')) timeStr = times.find(x => x.name === 'Ä°MSAK')?.time || t.time;
                                    if (t.id.includes('_1')) timeStr = times.find(x => x.name === 'Ã–ÄžLE')?.time || t.time;
                                    if (t.id.includes('_2')) timeStr = times.find(x => x.name === 'Ä°KÄ°NDÄ°')?.time || t.time;
                                    if (t.id.includes('_3')) timeStr = times.find(x => x.name === 'AKÅžAM')?.time || t.time;
                                    if (t.id.includes('_4')) timeStr = times.find(x => x.name === 'YATSI')?.time || t.time;
                                    
                                    return { ...t, time: timeStr };
                                }
                                return t;
                            });
                            // Re-sort day tasks by time
                            newTasks[dayId].sort((a, b) => a.time.localeCompare(b.time));
                        });
                        return newTasks;
                    });
                    
                    // Check Tutorial Status
                    const hasCompletedTutorial = localStorage.getItem('corthon_tutorial_completed');
                    if (!hasCompletedTutorial) {
                        setTimeout(() => setTutorialStep(1), 3500); // Wait for boot animation
                    }
                };
                initSystem();
            }, []);

            useEffect(() => {
                if (!mounted) return;
                const saveData = async () => {
                    const coreData = { xp, streak, tasks, history, settings };
                    await neuralDB.save('corthon_core', coreData);
                    localStorage.setItem('corthon_pro_v1', JSON.stringify(coreData)); 
                };
                const timeout = setTimeout(saveData, 1000);
                return () => clearTimeout(timeout);
            }, [xp, streak, tasks, history, settings, mounted]);

            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast({ msg: null, type: 'neutral' }), 3000);
            };

            const nextTutorialStep = () => {
                if (tutorialStep < 6) {
                    setTutorialStep(prev => prev + 1);
                    playSound('click');
                } else {
                    finishTutorial();
                }
            };

            const finishTutorial = () => {
                setTutorialStep(0);
                localStorage.setItem('corthon_tutorial_completed', 'true');
                playSound('success');
                showToast("SÄ°STEME ENTEGRE EDÄ°LDÄ°", "success");
            };

            const restartTutorial = () => {
                setManualOpen(false);
                setTutorialStep(1);
                playSound('boot');
            };

            // Existing Logic (Snippet for brevity)
            const todayStr = new Date().toISOString().split('T')[0];
            const isTodayProcessed = history[todayStr]?.processed;
            const handleSaveTask = (taskData) => {
                setTasks(prev => {
                    const dayTasks = [...(prev[selectedDayId] || [])];
                    if (editingTask) {
                        const idx = dayTasks.findIndex(t => t.id === editingTask.id);
                        if (idx !== -1) dayTasks[idx] = { ...dayTasks[idx], ...taskData };
                    } else {
                        dayTasks.push({ id: Date.now().toString(), completed: false, snoozed: 0, snoozePenalty: 0, ...taskData });
                    }
                    dayTasks.sort((a, b) => a.time.localeCompare(b.time));
                    return { ...prev, [selectedDayId]: dayTasks };
                });
                setModalOpen(false);
                setEditingTask(null);
                playSound('complete');
                if (isTodayProcessed && selectedDayId === new Date().getDay()) {
                    showToast("âš ï¸ PROTOKOL DEÄžÄ°ÅžTÄ°: Raporu GÃ¼ncellemelisin", "warning");
                } else {
                    showToast("SÄ°STEM: Yeni Protokol TanÄ±mlandÄ±", "system");
                }
            };
            const openSnoozeModal = (task) => setSnoozeModal({ open: true, task });
            const handleSnoozeConfirm = (reason) => {
                const { task } = snoozeModal;
                setTasks(prev => {
                    const dayTasks = [...(prev[selectedDayId] || [])];
                    const idx = dayTasks.findIndex(t => t.id === task.id);
                    if (idx === -1) return prev;
                    const oldPenalty = dayTasks[idx].snoozePenalty || 0;
                    dayTasks[idx] = { ...dayTasks[idx], snoozed: (dayTasks[idx].snoozed || 0) + 1, snoozePenalty: oldPenalty + reason.penalty };
                    return { ...prev, [selectedDayId]: dayTasks };
                });
                if (reason.penalty > 0) {
                    setXp(x => Math.max(0, x - reason.penalty));
                    playSound(reason.id === 'LAZY' ? 'lazy' : 'warning');
                    showToast(`âš ï¸ KORTÄ°ZOL: ${reason.label} (-${reason.penalty} XP)`, "warning");
                } else {
                    playSound('mercy');
                    showToast("ðŸ›¡ï¸ MERHAMET PROTOKOLÃœ: Ceza Yok", "system");
                }
                const today = new Date().toISOString().split('T')[0];
                setHistory(h => {
                    const dayH = h[today] || { categories: {}, snoozes: 0, reasons: {} };
                    const reasons = { ...dayH.reasons };
                    reasons[reason.id] = (reasons[reason.id] || 0) + 1;
                    return { ...h, [today]: { ...dayH, snoozes: (dayH.snoozes || 0) + 1, reasons } };
                });
                setSnoozeModal({ open: false, task: null });
            };
            const handleReschedule = (targetDayId) => {
                 const { task } = snoozeModal;
                 setTasks(prev => {
                    const currentDayTasks = prev[selectedDayId].filter(t => t.id !== task.id);
                    const targetDayTasks = [...(prev[targetDayId] || [])];
                    targetDayTasks.push({ ...task, snoozed: 0, snoozePenalty: 0 }); 
                    targetDayTasks.sort((a, b) => a.time.localeCompare(b.time));
                    return { ...prev, [selectedDayId]: currentDayTasks, [targetDayId]: targetDayTasks };
                 });
                 setXp(x => Math.max(0, x - 25)); 
                 playSound('warning');
                 showToast("ðŸ“… GÃ–REV Ã–TELENDÄ°: Planlama HatasÄ± (-25 XP)", "warning");
                 setSnoozeModal({ open: false, task: null });
            };
            const handleUndoSnooze = () => {
                const { task } = snoozeModal;
                if (!task || task.snoozed === 0) return;
                const penaltyToRestore = task.snoozePenalty || 0;
                setTasks(prev => {
                    const dayTasks = [...(prev[selectedDayId] || [])];
                    const idx = dayTasks.findIndex(t => t.id === task.id);
                    if (idx === -1) return prev;
                    dayTasks[idx] = { ...dayTasks[idx], snoozed: 0, snoozePenalty: 0 };
                    return { ...prev, [selectedDayId]: dayTasks };
                });
                if (penaltyToRestore > 0) {
                    setXp(x => x + penaltyToRestore);
                    showToast(`â™»ï¸ Ä°RADE YENÄ°LENDÄ°: +${penaltyToRestore} XP Ä°ade`, "success");
                } else {
                    showToast("â™»ï¸ ERTELEME Ä°PTAL EDÄ°LDÄ°", "success");
                }
                playSound('mercy');
                setSnoozeModal({ open: false, task: null });
            };
            const toggleTask = (taskId) => {
                setTasks(prev => {
                    const dayTasks = [...(prev[selectedDayId] || [])];
                    const idx = dayTasks.findIndex(t => t.id === taskId);
                    if (idx === -1) return prev;
                    const task = dayTasks[idx];
                    const newStatus = !task.completed;
                    const points = IMPACTS.find(i => i.id === task.impact)?.xp || 50;
                    const today = new Date().toISOString().split('T')[0];
                    if (newStatus) {
                        setXp(x => x + points);
                        playSound('success');
                        showToast(`âš¡ DOPAMÄ°N ENJEKTE EDÄ°LDÄ°: ${task.category} (+${points} XP)`, "success");
                        setHistory(h => {
                            const dayH = h[today] || { categories: {} };
                            const cats = { ...dayH.categories };
                            cats[task.category] = (cats[task.category] || 0) + 1;
                            return { ...h, [today]: { ...dayH, categories: cats } };
                        });
                    } else {
                        setXp(x => Math.max(0, x - points));
                        playSound('purge');
                        showToast(`ðŸ”» KORTÄ°ZOL UYARISI: Ä°rade KaybÄ± (-${points} XP)`, "danger");
                        setHistory(h => {
                            const dayH = h[today] || { categories: {} };
                            const cats = { ...dayH.categories };
                            cats[task.category] = Math.max(0, (cats[task.category] || 0) - 1);
                            return { ...h, [today]: { ...dayH, categories: cats } };
                        });
                    }
                    dayTasks[idx] = { ...task, completed: newStatus };
                    return { ...prev, [selectedDayId]: dayTasks };
                });
            };
            const deleteTask = (taskId) => {
                if (!taskId) return;
                const currentDayTasks = tasks[selectedDayId] || [];
                const taskToDelete = currentDayTasks.find(t => t.id === taskId);
                if (taskToDelete && taskToDelete.completed) {
                     const points = IMPACTS.find(i => i.id === taskToDelete.impact)?.xp || 50;
                     setXp(x => Math.max(0, x - points));
                     showToast(`âš–ï¸ ADALET SÄ°STEMÄ°: Tamamlanan gÃ¶rev silindi (-${points} XP)`, "warning");
                }
                setTasks(prev => {
                    const newState = { ...prev };
                    Object.keys(newState).forEach(key => {
                            if (Array.isArray(newState[key])) {
                                newState[key] = newState[key].filter(t => String(t.id) !== String(taskId));
                            }
                    });
                    return newState;
                });
                setModalOpen(false); setEditingTask(null);
                playSound('purge'); 
                if(!taskToDelete?.completed) showToast("â˜ ï¸ VERÄ° Ä°MHA EDÄ°LDÄ°", "danger");
            };
            const handleCompleteDay = () => {
                const currentDayIndex = new Date().getDay();
                const adjCurrent = currentDayIndex === 0 ? 7 : currentDayIndex;
                const adjSelected = selectedDayId === 0 ? 7 : selectedDayId;
                if (adjSelected > adjCurrent) {
                     playSound('warning');
                     showToast("Gelecek henÃ¼z yazÄ±lmadÄ±. Sadece bugÃ¼nÃ¼ raporlayabilirsin.", "warning");
                     return;
                }
                const todayTasks = tasks[selectedDayId] || [];
                const completed = todayTasks.filter(t => t.completed).length;
                const total = todayTasks.length;
                const processedData = history[todayStr];
                const alreadyProcessed = processedData?.processed;
                if (total === 0) { 
                    if(confirm("BugÃ¼n gÃ¶rev yok. 'Dinlenme GÃ¼nÃ¼' olarak iÅŸaretlensin mi? (+25 BakÄ±m XP)")) {
                        if (!alreadyProcessed) setXp(x => x + 25);
                         setHistory(prev => ({
                            ...prev,
                            [todayStr]: { ...prev[todayStr], processed: true, completionRatio: 1, type: 'REST' }
                        }));
                        playSound('success');
                        showToast("MENTAL BAKIM GÃœNÃœ KAYDEDÄ°LDÄ°.", "success");
                    }
                    return; 
                }
                if (completed === 0) {
                    playSound('purge');
                    showToast("SÄ°STEM BAÅžARISIZLIÄžI: %0 Verim. XP Verilmedi.", "danger");
                } else {
                    const ratio = completed / total;
                    let bonus = ratio >= 0.8 ? 150 : ratio >= 0.5 ? 75 : 25;
                    if (alreadyProcessed) {
                        showToast(`GÃœN RAPORU GÃœNCELLENDÄ°: %${Math.round(ratio*100)} Verim.`, "system");
                    } else {
                        setXp(x => x + bonus);
                        playSound('success');
                        showToast(`GÃœN KAPANIÅžI: %${Math.round(ratio*100)} Verim. +${bonus} Bonus XP`, "success");
                    }
                }
                setHistory(prev => ({
                    ...prev,
                    [todayStr]: { 
                        ...prev[todayStr],
                        processed: true,
                        completionRatio: completed / total,
                        totalTasks: total // Store total to check for changes later
                    }
                }));
            };
            const handleCompleteWeekTrigger = () => { setSummaryOpen(true); playSound('click'); };
            const confirmCompleteWeek = () => {
                setSummaryOpen(false);
                setIsResetting(true);
                setTimeout(() => {
                    setTasks(prev => {
                        const newTasks = {};
                        Object.keys(prev).forEach(dayId => {
                            newTasks[dayId] = prev[dayId].map(t => ({
                                ...t, completed: false, snoozed: 0, snoozePenalty: 0
                            }));
                        });
                        return newTasks;
                    });
                    setStreak(s => s + 1);
                    setXp(x => x + 500); 
                    playSound('boot'); 
                    setIsResetting(false);
                    showToast("SÄ°STEM YENÄ°DEN BAÅžLATILDI. YENÄ° HAFTA.", "success");
                }, 1500);
            };
            const handlePurgeSystem = async () => {
                if(confirm("DÄ°KKAT: TÃœM Ä°LERLEME SÄ°LÄ°NECEK.")) {
                    await neuralDB.clearAll();
                    localStorage.clear();
                    playSound('purge');
                    setXp(0);
                    setStreak(0);
                    setTasks(generateInitialRoutine());
                    setHistory({});
                    showToast("SÄ°STEM SIFIRLANDI", "danger");
                    setTimeout(() => window.location.reload(), 1500);
                }
            };
            const handleToggleSetting = (key) => setAppSettings(prev => ({ ...prev, [key]: !prev[key] }));
            
            const level = Math.floor(Math.sqrt(xp / XP_DIFFICULTY_SCALAR)) + 1;
            const nextLevelXp = Math.pow(level, 2) * XP_DIFFICULTY_SCALAR;
            const currentLevelBaseXp = Math.pow(level - 1, 2) * XP_DIFFICULTY_SCALAR;
            const progressPercent = Math.min(100, Math.max(0, ((xp - currentLevelBaseXp) / (nextLevelXp - currentLevelBaseXp)) * 100));
            const todayTasks = tasks[selectedDayId] || [];
            const standardTasks = todayTasks.filter(t => t.category !== 'NAMAZ');
            const prayerTasks = todayTasks.filter(t => t.category === 'NAMAZ');
            const totalSnoozes = Object.values(history).reduce((acc, curr) => acc + (curr.snoozes || 0), 0);
            const snoozeReasons = Object.values(history).reduce((acc, curr) => {
                if(curr.reasons) Object.entries(curr.reasons).forEach(([r, c]) => acc[r] = (acc[r] || 0) + c);
                return acc;
            }, {});
            
            const currentDayIndex = new Date().getDay();
            const adjCurrent = currentDayIndex === 0 ? 7 : currentDayIndex;
            const adjSelected = selectedDayId === 0 ? 7 : selectedDayId;
            const isFuture = adjSelected > adjCurrent;
            const histData = history[todayStr];
            const hasChangedSinceProcess = histData && histData.processed && (histData.totalTasks !== todayTasks.length || histData.completionRatio !== (todayTasks.filter(t=>t.completed).length / (todayTasks.length || 1)));

            const stats = useMemo(() => {
                const s = { ÃœRETÄ°M: 0, FÄ°ZÄ°KSEL: 0, MANEVÄ°YAT: 0, SOSYAL: 0 };
                Object.values(history).forEach(day => {
                    if (day.categories) Object.entries(day.categories).forEach(([cat, count]) => {
                        if (MACRO_AXES['ÃœRETÄ°M'].includes(cat)) s.ÃœRETÄ°M += count;
                        if (MACRO_AXES['FÄ°ZÄ°KSEL'].includes(cat)) s.FÄ°ZÄ°KSEL += count;
                        if (MACRO_AXES['MANEVÄ°YAT'].includes(cat)) s.MANEVÄ°YAT += count;
                        if (MACRO_AXES['SOSYAL'].includes(cat)) s.SOSYAL += count;
                    });
                });
                return s;
            }, [history]);

            if (!mounted) return <BootScreen onComplete={() => setMounted(true)} />;

            return (
                <div className={`min-h-screen pb-36 safe-area-bottom transition-colors duration-500 ${isResetting ? 'opacity-50 grayscale' : ''}`}>
                    
                    {/* Tutorial Dark Overlay */}
                    {tutorialStep > 0 && (
                        <div className="fixed inset-0 z-[50] bg-black/50 backdrop-blur-[1px] transition-opacity duration-500"></div>
                    )}
                    
                    <TutorialOverlay step={tutorialStep} onNext={nextTutorialStep} onSkip={finishTutorial} />

                    {/* Reset Overlay */}
                    {isResetting && (
                         <div className="fixed inset-0 z-[300] bg-black/80 flex flex-col items-center justify-center backdrop-blur-sm">
                            <RefreshCw className="animate-spin text-corthon-emerald mb-4" size={48} />
                            <div className="text-corthon-emerald font-mono animate-pulse">SÄ°STEM YENÄ°LENÄ°YOR...</div>
                         </div>
                    )}

                    {/* Header */}
                    <div className="bg-[#09090b]/90 backdrop-blur-md sticky top-0 z-30 border-b border-white/5 safe-area-top shadow-xl shadow-black/50">
                        <div className="px-5 py-4 flex justify-between items-center">
                            <h1 className="font-bold tracking-tight text-lg flex items-center gap-3 font-sans"><CorthonLogo /><span className="text-white">CORTHON</span></h1>
                            <div className="flex items-center gap-4">
                                <button onClick={() => setManualOpen(true)} className="text-gray-500 hover:text-white transition-colors"><HelpCircle size={20} /></button>
                                <div className={`flex flex-col items-end transition-all duration-500 ${tutorialStep === 2 ? 'tutorial-highlight p-2 bg-[#09090b]' : ''}`}>
                                    <div className="flex items-center gap-2 text-xs font-bold text-white font-mono">Lvl {level} <span className="text-corthon-emerald">{xp} XP</span></div>
                                    <div className="w-24 h-1 bg-gray-800 rounded-full mt-1 overflow-hidden"><div className="h-full bg-corthon-emerald transition-all duration-1000 ease-out" style={{width: `${progressPercent}%`}}></div></div>
                                </div>
                            </div>
                        </div>
                        <div className={`px-5 pb-0 flex gap-6 border-b border-white/5 ${tutorialStep === 6 ? 'tutorial-highlight bg-[#09090b] rounded-none' : ''}`}>
                            <button onClick={() => setView('FLOW')} className={`pb-3 text-sm font-medium border-b-2 transition-colors ${view === 'FLOW' ? 'text-white border-corthon-emerald' : 'text-gray-500 border-transparent hover:text-gray-300'}`}>GÃ¼nlÃ¼k AkÄ±ÅŸ</button>
                            <button onClick={() => setView('ANALYTICS')} className={`pb-3 text-sm font-medium border-b-2 transition-colors ${view === 'ANALYTICS' ? 'text-white border-corthon-emerald' : 'text-gray-500 border-transparent hover:text-gray-300'}`}>Performans</button>
                            <button onClick={() => setView('SETTINGS')} className={`pb-3 text-sm font-medium border-b-2 transition-colors flex items-center gap-2 ${view === 'SETTINGS' ? 'text-white border-corthon-emerald' : 'text-gray-500 border-transparent hover:text-gray-300'}`}>Sistem</button>
                        </div>
                    </div>

                    <main className="px-5 pt-6 max-w-2xl mx-auto">
                        
                        {view === 'FLOW' && (
                            <div className="animate-slide-up">
                                <Greeting />
                                <div className={`flex justify-between mb-8 overflow-x-auto pb-2 scrollbar-hide -mx-5 px-5 transition-all duration-500 ${tutorialStep === 3 ? 'tutorial-highlight py-2 bg-[#09090b]' : ''}`}>
                                    {DAYS.map(d => {
                                        const isSelected = d.id === selectedDayId;
                                        const isToday = d.id === new Date().getDay();
                                        return (
                                            <button 
                                                key={d.id} 
                                                onClick={() => { setSelectedDayId(d.id); playSound('click'); }}
                                                className={`flex flex-col items-center min-w-[3.5rem] py-2 rounded-xl transition-all ${isSelected ? 'bg-white text-black shadow-lg shadow-white/10 scale-105' : 'bg-white/5 text-gray-500 hover:bg-white/10'}`}
                                            >
                                                <span className="text-xs font-medium mb-1">{d.short}</span>
                                                {isToday && <div className={`w-1 h-1 rounded-full ${isSelected ? 'bg-black' : 'bg-corthon-emerald'}`}></div>}
                                            </button>
                                        );
                                    })}
                                </div>

                                <div className="space-y-4">
                                    <div className="flex justify-between items-end mb-2">
                                        <h2 className="text-xl font-bold text-white tracking-tight">{DAYS.find(d => d.id === selectedDayId).name}</h2>
                                        <span className="text-xs text-gray-500 font-mono bg-white/5 px-2 py-1 rounded">
                                            {standardTasks.filter(t=>t.completed).length} / {standardTasks.length} TamamlandÄ±
                                        </span>
                                    </div>

                                    {standardTasks.length === 0 ? (
                                        <div onClick={() => { setEditingTask(null); setModalOpen(true); }} className="border border-dashed border-white/10 rounded-2xl p-8 text-center text-gray-500 hover:bg-white/5 hover:border-white/20 cursor-pointer transition-all">
                                            <Plus className="mx-auto mb-2 opacity-50"/>
                                            <p className="text-sm font-medium">BugÃ¼n iÃ§in bir planÄ±n yok.</p>
                                            <p className="text-xs mt-1 text-corthon-emerald">Yeni gÃ¶rev eklemek iÃ§in dokun.</p>
                                        </div>
                                    ) : (
                                        standardTasks.map(task => {
                                            const impactColor = IMPACTS.find(i => i.id === task.impact)?.color || 'text-gray-400';
                                            return (
                                                <div 
                                                    key={task.id}
                                                    onClick={() => !task.completed && setFocusMode({ active: true, task })}
                                                    className={`group glass-panel rounded-xl p-4 transition-all active:scale-[0.99] cursor-pointer border-l-4 ${task.completed ? 'opacity-50 grayscale border-l-gray-700' : 'hover:border-white/20 border-l-corthon-emerald'}`}
                                                >
                                                    <div className="flex items-start gap-4">
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); toggleTask(task.id); }}
                                                            className={`mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${task.completed ? 'bg-corthon-emerald border-corthon-emerald text-black' : 'border-gray-600 hover:border-corthon-emerald text-transparent'}`}
                                                        >
                                                            <Check size={14} strokeWidth={3} />
                                                        </button>
                                                        
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-2 mb-1.5">
                                                                <span className="text-xs font-mono text-gray-400 bg-white/5 px-1.5 py-0.5 rounded flex items-center gap-1"><Clock size={10}/> {task.time}</span>
                                                                <span className="text-[10px] uppercase tracking-wider text-gray-500 border border-white/10 px-1.5 py-0.5 rounded font-bold">{task.category}</span>
                                                                {task.snoozed > 0 && <span className="text-[10px] uppercase tracking-wider text-corthon-warning border border-corthon-warning/30 bg-corthon-warning/10 px-1.5 py-0.5 rounded font-bold flex items-center gap-1"><Hourglass size={10} /> ERTELENDÄ° x{task.snoozed}</span>}
                                                            </div>
                                                            <h3 className={`font-semibold text-base truncate mb-1 ${task.completed ? 'line-through text-gray-500' : 'text-gray-100'}`}>{task.title}</h3>
                                                            {task.note && <p className="text-xs text-gray-500 line-clamp-2 leading-relaxed font-sans">{task.note}</p>}
                                                        </div>

                                                        <div className="flex flex-col gap-1">
                                                            <button onClick={(e) => { e.stopPropagation(); setEditingTask(task); setModalOpen(true); }} className="p-2 text-gray-500 hover:text-white transition-opacity bg-white/5 rounded-lg hover:bg-white/10"><Edit3 size={16} /></button>
                                                            <button onClick={(e) => { e.stopPropagation(); openSnoozeModal(task); }} className="p-2 text-corthon-warning hover:text-white transition-opacity bg-corthon-warning/10 rounded-lg hover:bg-corthon-warning/20 border border-corthon-warning/20"><History size={16} /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>

                                {/* Prayer Section */}
                                <div className="mt-8 mb-8">
                                    <div className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2"><Moon size={12}/> Manevi Rutin</div>
                                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                        {prayerTimes.map((p) => (
                                            <div key={p.name} className="flex-shrink-0 bg-white/5 border border-white/5 rounded px-3 py-2 flex flex-col items-center min-w-[70px]">
                                                <span className="text-[9px] font-bold text-gray-400 mb-1">{p.name}</span>
                                                <span className="text-xs font-mono text-corthon-emerald">{p.time}</span>
                                            </div>
                                        ))}
                                    </div>
                                    {prayerTasks.length > 0 && (
                                        <div className="mt-4 grid grid-cols-3 sm:grid-cols-6 gap-3">
                                            {prayerTasks.map(task => (
                                                <button key={task.id} onClick={() => toggleTask(task.id)} className={`flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-300 relative overflow-hidden group ${task.completed ? 'bg-corthon-emerald/20 border-corthon-emerald text-corthon-emerald shadow-[0_0_15px_rgba(16,185,129,0.15)]' : 'bg-white/5 border-white/5 text-gray-500 hover:bg-white/10'}`}>
                                                    <span className="text-[10px] font-bold truncate w-full text-center tracking-wide">{task.title.replace(' NamazÄ±', '')}</span>
                                                    <div className="mt-2 transition-transform group-hover:scale-110">{task.completed ? <CheckCircle2 size={20} strokeWidth={2.5} /> : <div className="w-5 h-5 rounded-full border-2 border-white/20"></div>}</div>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className={`mt-10 mb-6 space-y-4 transition-all duration-500 ${tutorialStep === 5 ? 'tutorial-highlight p-2 bg-[#09090b]' : ''}`}>
                                    <button 
                                        onClick={handleCompleteDay}
                                        disabled={isFuture} 
                                        className={`w-full py-4 rounded-xl bg-gradient-to-r border flex items-center justify-center gap-3 text-sm font-bold transition-all group relative overflow-hidden
                                            ${isFuture ? 'from-gray-800 to-gray-800 border-gray-700 text-gray-500 cursor-not-allowed' : 
                                              hasChangedSinceProcess ? 'from-yellow-900/40 to-yellow-800/40 border-yellow-500/50 text-yellow-500 hover:text-white hover:border-yellow-500' :
                                              isTodayProcessed ? 'from-gray-900 to-gray-800 border-white/10 text-corthon-emerald/70' : 
                                              'from-gray-900 to-gray-800 border-white/10 hover:border-corthon-emerald/50 hover:from-gray-800 text-white'}
                                        `}
                                    >
                                        <Flag size={18} className={`${isTodayProcessed && !hasChangedSinceProcess ? 'text-corthon-emerald' : hasChangedSinceProcess ? 'text-yellow-500 animate-pulse' : 'text-corthon-orange group-hover:rotate-12 transition-transform'}`}/> 
                                        {isFuture ? 'GELECEK KÄ°LÄ°TLÄ°' : hasChangedSinceProcess ? 'RAPORU GÃœNCELLE (DeÄŸiÅŸiklik Var)' : isTodayProcessed ? 'RAPOR GÃœNCEL' : 'GÃœNÃœ TAMAMLA & RAPORLA'}
                                    </button>

                                    {selectedDayId === 0 && (
                                        <button onClick={handleCompleteWeekTrigger} className="w-full py-4 rounded-xl bg-corthon-emerald text-black flex items-center justify-center gap-3 text-sm font-bold shadow-lg shadow-corthon-emerald/20 hover:scale-[1.02] transition-transform">
                                            <RefreshCw size={18} className="animate-pulse-slow"/> HAFTAYI BÄ°TÄ°R & YENÄ°LE
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'ANALYTICS' && (
                            <div className="animate-slide-up space-y-6">
                                <div className="glass-panel p-6 rounded-2xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-6 opacity-10"><Zap size={100} /></div>
                                    <div className="relative z-10">
                                        <div className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">CORTHON PROTOKOLÃœ</div>
                                        <div className="text-4xl font-bold text-white mb-2 font-mono">{xp} <span className="text-lg text-corthon-emerald">XP</span></div>
                                        <div className="inline-block px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs font-mono text-gray-400">Lvl {level+1} iÃ§in: {Math.floor(nextLevelXp - xp)} XP kaldÄ±</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    <div className="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center"><TrendingUp size={20} className="text-corthon-cyan mb-2"/><div className="text-xl font-bold text-white">{streak}</div><div className="text-[10px] text-gray-500 uppercase tracking-wider">Seri</div></div>
                                    <div className="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center"><CheckCircle2 size={20} className="text-corthon-emerald mb-2"/><div className="text-xl font-bold text-white">{Object.values(history).reduce((acc, curr) => acc + (curr.categories ? Object.values(curr.categories).reduce((a, b) => a + b, 0) : 0), 0)}</div><div className="text-[10px] text-gray-500 uppercase tracking-wider">GÃ¶rev</div></div>
                                    <div className="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center"><Percent size={20} className="text-corthon-orange mb-2"/><div className="text-xl font-bold text-white">{(Math.min(100, (xp / (streak * 100 || 1)) * 10)).toFixed(0)}%</div><div className="text-[10px] text-gray-500 uppercase tracking-wider">Verim</div></div>
                                    <div className="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center border-corthon-warning/20 bg-corthon-warning/5"><History size={20} className="text-corthon-warning mb-2"/><div className="text-xl font-bold text-white">{totalSnoozes}</div><div className="text-[10px] text-corthon-warning uppercase tracking-wider">Disiplin SÄ±zÄ±ntÄ±sÄ±</div></div>
                                </div>
                                <div className="glass-panel p-6 rounded-2xl"><div className="flex items-center gap-2 mb-4"><AlertTriangle size={18} className="text-corthon-warning"/><h3 className="font-bold text-sm tracking-wide text-white">Ä°RADESÄ°ZLÄ°K ANALÄ°ZÄ° (Sebepler)</h3></div>
                                    <div className="space-y-3">{Object.keys(snoozeReasons).length === 0 ? <div className="text-xs text-gray-500 text-center py-4">HenÃ¼z bir sÄ±zÄ±ntÄ± tespit edilmedi.</div> : SNOOZE_REASONS.map(reason => {const count = snoozeReasons[reason.id] || 0; if(count===0) return null; const max = Math.max(...Object.values(snoozeReasons), 1); const pct = (count/max)*100; return (<div key={reason.id} className="space-y-1"><div className="flex justify-between text-xs"><span className="text-gray-400 flex items-center gap-1"><reason.icon size={10} /> {reason.label}</span><span className="text-white font-mono">{count}</span></div><div className="h-1.5 w-full bg-white/5 rounded-full overflow-hidden"><div className={`h-full ${reason.bg.replace('/10', '')} transition-all duration-1000`} style={{width: `${pct}%`}}></div></div></div>)})}</div>
                                </div>
                                <div className="glass-panel p-6 rounded-2xl"><div className="flex items-center gap-2 mb-4"><Flame size={18} className="text-orange-500"/><h3 className="font-bold text-sm tracking-wide text-white">Ä°STÄ°KRAR ZÄ°NCÄ°RÄ° (Son 30 GÃ¼n)</h3></div><Heatmap history={history} /></div>
                                <div className="glass-panel p-6 rounded-2xl"><div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><Activity size={18} className="text-corthon-emerald"/><h3 className="font-bold text-sm tracking-wide text-white">YAÅžAM DENGESÄ°</h3></div></div><RadarChart stats={stats} /></div>
                            </div>
                        )}

                        {view === 'SETTINGS' && (
                            <SettingsView 
                                onPurge={handlePurgeSystem} 
                                storageStatus={storageStatus}
                                settings={settings}
                                onToggleSetting={handleToggleSetting}
                                onForceWeekReset={handleCompleteWeekTrigger}
                            />
                        )}
                    </main>

                    {view === 'FLOW' && (<button onClick={() => { setEditingTask(null); setModalOpen(true); playSound('click'); }} className={`fixed bottom-10 right-6 w-16 h-16 bg-white text-black rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(255,255,255,0.3)] hover:scale-110 active:scale-95 transition-all z-40 ${tutorialStep === 4 ? 'tutorial-highlight' : ''}`}><Plus size={32} strokeWidth={2.5} /></button>)}

                    {toast.msg && (<div className={`fixed top-24 left-4 right-4 sm:left-1/2 sm:right-auto sm:-translate-x-1/2 sm:w-auto max-w-md p-4 rounded-2xl font-bold text-sm shadow-2xl animate-slide-up z-[100] flex items-center gap-3 border border-white/10 backdrop-blur-xl ${toast.type === 'success' ? 'bg-corthon-emerald/90 text-black' : ''} ${toast.type === 'danger' ? 'bg-red-500/90 text-white' : ''} ${toast.type === 'warning' ? 'bg-corthon-warning/90 text-black' : ''} ${toast.type === 'system' ? 'bg-corthon-cyan/90 text-black' : ''}`}>{toast.type === 'success' && <Zap size={16} className="shrink-0"/>}{toast.type === 'danger' && <AlertTriangle size={16} className="shrink-0"/>}{toast.type === 'warning' && <History size={16} className="shrink-0"/>}{toast.type === 'system' && <Database size={16} className="shrink-0"/>}<span className="flex-1 leading-tight">{toast.msg}</span></div>)}

                    <TaskEditor isOpen={modalOpen} onClose={() => setModalOpen(false)} onSave={handleSaveTask} onDelete={deleteTask} initialData={editingTask} />
                    <SnoozeModal isOpen={snoozeModal.open} task={snoozeModal.task} onClose={() => setSnoozeModal({ open: false, task: null })} onConfirm={handleSnoozeConfirm} onReschedule={handleReschedule} onUndo={handleUndoSnooze} />
                    <FocusMode active={focusMode.active} task={focusMode.task} onClose={() => setFocusMode({ active: false, task: null })} />
                    <ManualModal isOpen={manualOpen} onClose={() => setManualOpen(false)} onRestartTutorial={restartTutorial} />
                    <SummaryModal isOpen={summaryOpen} onClose={() => setSummaryOpen(false)} xp={xp} tasks={Object.values(history).reduce((acc, curr) => acc + (curr.categories ? Object.values(curr.categories).reduce((a, b) => a + b, 0) : 0), 0)} onConfirm={confirmCompleteWeek} />
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
